# ADR Compliance Audit: "One Decision Per ADR" Principle

**Date:** 2025-01-19
**Auditor:** Claude Code (AI Agent)
**Principle:** Each ADR must capture exactly ONE architectural decision, not several independent decisions
**Status:** 7/10 Compliant, 3/10 Require Review/Splitting

---

## Executive Summary

After auditing all 10 existing ADRs (ADR-001 through ADR-010) against the "One Decision Per ADR" principle, I found:

- **✅ 7 ADRs Compliant**: Single cohesive decisions
- **⚠️ 2 ADRs Violations**: Bundle multiple independent decisions
- **⚠️ 1 ADR Borderline**: Arguable whether bundling is appropriate

### Violations Requiring Action

| ADR | Issue | Severity | Recommendation |
|-----|-------|----------|----------------|
| **ADR-003** | Bundles Database + ORM + Hosting + Migrations | HIGH | Split into 4 ADRs |
| **ADR-007** | Bundles API hosting + Web hosting + DB hosting + CI/CD | HIGH | Split into 4 ADRs |
| **ADR-005** | Bundles Shadcn + Tailwind CSS | MEDIUM | Keep or split (arguable) |

---

## Detailed Analysis

### ✅ ADR-001: API Framework - FastAPI

**Decision:** Use FastAPI + Python 3.11+

**Analysis:**
- **Core decision**: FastAPI as backend framework
- **Python version**: Inseparable from FastAPI (FastAPI requires Python 3.11+)
- **Can change independently?** NO - Python version is a prerequisite, not a separate choice

**Verdict:** ✅ **COMPLIANT** - One cohesive decision

---

### ✅ ADR-002: Web Framework - Next.js App Router

**Decision:** Use Next.js 14+ with App Router

**Analysis:**
- **Core decision**: Next.js as frontend framework
- **App Router choice**: Inseparable from Next.js 14+ decision
- **Can change independently?** NO - App Router vs Pages Router is part of choosing Next.js

**Verdict:** ✅ **COMPLIANT** - One cohesive decision (framework + router mode)

---

### ⚠️ ADR-003: Database & ORM - PostgreSQL + SQLAlchemy on Fly.io

**Decision:**
1. Database: PostgreSQL 15+
2. ORM: SQLAlchemy 2.0
3. Migrations: Alembic
4. Hosting: Fly.io Postgres

**Analysis:**
- **Can change database independently?** YES - Could switch PostgreSQL → MySQL without changing ORM
- **Can change ORM independently?** YES - Could switch SQLAlchemy → Prisma without changing database
- **Can change hosting independently?** YES - Could switch Fly.io → Railway without changing database
- **Can change migrations independently?** YES - Could switch Alembic → other tool

**Test for independence:**
```
Question: If we wanted to switch from PostgreSQL to MySQL, would we need to supersede this entire ADR?
Answer: YES (but we should only need to supersede the "database" decision, not ORM/hosting/migrations)
```

**Verdict:** ⚠️ **VIOLATION** - Bundles 4 independent decisions

**Recommended split:**
- **ADR-003A**: PostgreSQL Database
- **ADR-003B**: SQLAlchemy ORM
- **ADR-003C**: Alembic Migrations
- **ADR-003D**: Fly.io Postgres Hosting

---

### ✅ ADR-004: Email Service - Resend

**Decision:** Use Resend for email delivery

**Analysis:**
- **Core decision**: Resend as email provider
- **Single choice**: No bundling of multiple services

**Verdict:** ✅ **COMPLIANT** - One clear decision

---

### ⚠️ ADR-005: UI Framework - Shadcn/ui + Tailwind CSS

**Decision:**
1. Component library: Shadcn/ui
2. Styling approach: Tailwind CSS
3. Accessibility primitives: Radix UI (via Shadcn)

**Analysis:**
- **Can change component library independently?** YES - Could switch Shadcn → Material-UI without changing Tailwind
- **Can change styling independently?** YES - Could switch Tailwind → CSS Modules without changing Shadcn
- **Radix UI**: Coupled with Shadcn (not independent)

**Counterargument (per CLAUDE.md guidance):**
> "Multiple tools that form ONE strategy (e.g., 'Type Safety Strategy' = mypy + Pydantic + TypeScript + Zod work together)"

**Does Shadcn + Tailwind form ONE strategy?**
- Shadcn IS built on Tailwind (designed specifically for it)
- BUT: You can use Tailwind without Shadcn (they're not inseparable)
- AND: You could use Shadcn with other CSS approaches (theoretically)

**Verdict:** ⚠️ **BORDERLINE** - Arguable whether this violates the principle

**Options:**
1. **Keep as-is**: Treat as "UI Component & Styling Strategy" (one cohesive approach)
2. **Split**: ADR-005A (Shadcn/ui), ADR-005B (Tailwind CSS)

**Recommendation:** **KEEP AS-IS** - Shadcn + Tailwind work tightly together, and the precedent from ADR-006 (Type Safety Strategy) supports bundling tightly-coupled tools.

---

### ✅ ADR-006: Type Safety Strategy

**Decision:**
- API: Mypy (static) + Pydantic (runtime) + Ruff (linting)
- Web: TypeScript strict (static) + Zod (runtime) + ESLint (linting)
- Integration: OpenAPI → TypeScript type generation

**Analysis:**
- **Can change tools independently?** YES (Mypy → Pyright, Pydantic → other, etc.)
- **Is this a "strategy"?** YES (explicitly titled "Type Safety STRATEGY")
- **Do tools work together?** YES (forms cohesive type safety approach)

**Per CLAUDE.md guidance:**
> "Multiple tools that form ONE strategy... Trade-off: If one part of the bundle needs changing, the entire ADR must be superseded"

**Verdict:** ✅ **COMPLIANT** - Explicitly documented as a strategy, not individual tool choices. Acceptable bundling per established guidance.

---

### ⚠️ ADR-007: Deployment Strategy

**Decision:**
1. API hosting: Fly.io (Frankfurt)
2. Web hosting: Vercel (global CDN)
3. Database: Fly.io Postgres (Frankfurt)
4. CI/CD: GitHub Actions

**Analysis:**
- **Can change API hosting independently?** YES - Could switch Fly.io → AWS without changing web hosting
- **Can change web hosting independently?** YES - Could switch Vercel → Netlify without changing API hosting
- **Can change database hosting independently?** YES - Could switch to Railway without changing API hosting
- **Can change CI/CD independently?** YES - Could switch GitHub Actions → GitLab CI without changing hosting

**Test for independence:**
```
Question: If we wanted to switch from Vercel to Netlify for web hosting, would we need to supersede this entire ADR?
Answer: YES (but we should only need to supersede the "web hosting" decision)
```

**Counterargument:**
Is this a "Deployment STRATEGY" like "Type Safety STRATEGY" in ADR-006?

**Key difference:**
- ADR-006 tools work TOGETHER (Mypy validates what Pydantic checks at runtime)
- ADR-007 choices are INDEPENDENT (web hosting doesn't depend on API hosting)

**Verdict:** ⚠️ **VIOLATION** - Bundles 4 independent decisions

**Recommended split:**
- **ADR-007A**: Fly.io for Backend Hosting
- **ADR-007B**: Vercel for Frontend Hosting
- **ADR-007C**: Fly.io Postgres for Database Hosting
- **ADR-007D**: GitHub Actions for CI/CD

---

### ✅ ADR-008: Testing Strategy

**Decision:**
- API: Pytest + pytest-asyncio + Faker
- Web: Playwright + Axe-core
- Coverage: >80% target
- CI/CD integration

**Analysis:**
- **Is this a "strategy"?** YES (explicitly titled "Testing STRATEGY")
- **Do tools work together?** YES (forms cohesive testing approach)
- **Similar to ADR-006?** YES (both are strategies with multiple tools)

**Verdict:** ✅ **COMPLIANT** - Explicitly documented as a strategy. Acceptable bundling.

---

### ✅ ADR-009: Test Data Patterns

**Decision:**
1. Factory functions for test data
2. Shared utilities
3. Scenario fixtures
4. Parametrized tests
5. Documentation standard

**Analysis:**
- **Are these independent?** NO - They all relate to "how we manage test data"
- **One cohesive decision?** YES - "Test Data Management Approach"
- **Could change parts independently?** Technically yes, but they form one pattern

**Verdict:** ✅ **COMPLIANT** - One decision about test data patterns

---

### ✅ ADR-010: DateTime Storage and Timezone Strategy

**Decision:**
1. Storage format: TIMESTAMP WITHOUT TIME ZONE (naive)
2. Timezone assumption: Europe/Berlin
3. Library: pytz

**Analysis:**
- **Naive storage + timezone assumption**: INSEPARABLE (naive storage requires knowing what it represents)
- **Library choice (pytz)**: Could be independent, but documented in "Implementation Notes" not as core decision
- **Core decision**: "Store naive datetimes representing Europe/Berlin time"

**Verdict:** ✅ **COMPLIANT** - One cohesive storage strategy

---

## Migration Plan for Violations

### Critical: ADR-003 (Database & ORM)

**Current state:**
- Single ADR bundles 4 independent decisions

**Migration approach:**

#### Phase 1: Create New Split ADRs
1. **Create ADR-003A**: PostgreSQL Database
   - Decision: Use PostgreSQL 15+ for relational data
   - Rationale: ACID, range types, GiST indexes
   - Status: Accepted

2. **Create ADR-003B**: SQLAlchemy ORM
   - Decision: Use SQLAlchemy 2.0 as Python ORM
   - Rationale: Type safety, async support, AI-friendly
   - Status: Accepted

3. **Create ADR-003C**: Alembic Migrations
   - Decision: Use Alembic for database migrations
   - Rationale: SQLAlchemy integration, version control
   - Status: Accepted

4. **Create ADR-003D**: Fly.io Postgres Hosting
   - Decision: Host PostgreSQL on Fly.io (Frankfurt)
   - Rationale: Co-location with API, always-on
   - Status: Accepted

#### Phase 2: Deprecate ADR-003
1. Update ADR-003 status: `Superseded by ADR-003A, ADR-003B, ADR-003C, ADR-003D`
2. Keep original content unchanged (historical record)

#### Phase 3: Update References
Update files that reference ADR-003:
- `/docs/architecture/CLAUDE.md` (lines 303-314)
- `/docs/architecture/README.md` (line 94)
- ADR-001 (line 344)
- ADR-006 (line 877)
- ADR-007 (line 981)
- Any other cross-references

**Backward compatibility:**
- All 4 new ADRs together have same effect as old ADR-003
- No code changes required
- Only documentation split

---

### Critical: ADR-007 (Deployment Strategy)

**Current state:**
- Single ADR bundles 4 independent decisions

**Migration approach:**

#### Phase 1: Create New Split ADRs
1. **Create ADR-007A**: Fly.io Backend Hosting
   - Decision: Deploy FastAPI backend to Fly.io (Frankfurt)
   - Rationale: EU region, zero-downtime, Docker-based
   - Status: Accepted

2. **Create ADR-007B**: Vercel Frontend Hosting
   - Decision: Deploy Next.js to Vercel
   - Rationale: Zero-config, CDN, preview deployments
   - Status: Accepted

3. **Create ADR-007C**: Fly.io Postgres Hosting
   - Decision: Host PostgreSQL on Fly.io (co-located with backend)
   - Rationale: Low latency, always-on, same platform
   - Status: Accepted
   - **Note:** This overlaps with ADR-003D - we can reference it instead

4. **Create ADR-007D**: GitHub Actions CI/CD
   - Decision: Use GitHub Actions for CI/CD
   - Rationale: Integrated, free tier, AI-friendly YAML
   - Status: Accepted

#### Phase 2: Deprecate ADR-007
1. Update ADR-007 status: `Superseded by ADR-007A, ADR-007B, ADR-007C, ADR-007D`
2. Keep original content unchanged (historical record)

#### Phase 3: Update References
Update files that reference ADR-007:
- `/docs/architecture/CLAUDE.md` (lines 305-314)
- `/docs/architecture/README.md` (line 98)
- ADR-002 (line 419)
- ADR-008 (line 786)
- Any other cross-references

**Backward compatibility:**
- All 4 new ADRs together have same effect as old ADR-007
- No code changes required
- Only documentation split

---

### Medium Priority: ADR-005 (UI Framework)

**Decision:** Keep as-is for now

**Rationale:**
- Shadcn + Tailwind are tightly coupled (Shadcn designed for Tailwind)
- Precedent from ADR-006 supports bundling tightly-coupled tools as strategy
- Splitting would create artificial separation

**If future need arises:**
- Can split into ADR-005A (Shadcn) and ADR-005B (Tailwind)
- But for now, treating as cohesive "UI Strategy" is acceptable

---

## Summary of Actions Required

### Immediate (Before Next ADR Creation)

1. **Create 8 new ADRs** to split ADR-003 and ADR-007:
   - ADR-003A: PostgreSQL Database
   - ADR-003B: SQLAlchemy ORM
   - ADR-003C: Alembic Migrations
   - ADR-003D: Fly.io Postgres Hosting
   - ADR-007A: Fly.io Backend Hosting
   - ADR-007B: Vercel Frontend Hosting
   - ADR-007D: GitHub Actions CI/CD (007C covered by 003D)

2. **Update ADR-003 and ADR-007**:
   - Change status to "Superseded"
   - Add supersession references
   - Keep original content unchanged

3. **Update all cross-references**:
   - CLAUDE.md
   - README.md
   - Other ADRs
   - Any implementation docs

4. **Update ADR numbering in CLAUDE.md**:
   - Next ADR will be ADR-011 (CORS)
   - But we'll insert ADR-003A/B/C/D and ADR-007A/B/D first
   - Final next available: ADR-012

### Post-Split (Governance)

5. **Add ADR splitting guidance to CLAUDE.md**:
   - Document when/how to split existing ADRs
   - Provide examples of proper splitting
   - Clarify "strategy vs bundling" distinction

6. **Update ADR template**:
   - Add "Supersedes" field more prominently
   - Add "Split from" field for split ADRs

---

## Governance Recommendations

### Updated "One Decision Per ADR" Guidance

Add to `/docs/architecture/CLAUDE.md`:

```markdown
### Strategy vs Bundle: When is bundling acceptable?

**Acceptable bundling (as "strategy"):**
- Tools work TOGETHER toward one goal (e.g., Type Safety: Mypy validates → Pydantic checks at runtime)
- Choices are INTERDEPENDENT (changing one affects others)
- Explicitly named as "STRATEGY" in ADR title

**Unacceptable bundling:**
- Choices are INDEPENDENT (can change one without affecting others)
- Separate concerns bundled for convenience
- "Stack" decisions that could vary independently

**Test for independence:**
"If we wanted to change choice X, would we need to supersede choices Y and Z?"
- If NO → Separate ADRs needed
- If YES → One ADR acceptable

**Examples:**
✅ GOOD: "Type Safety Strategy" (Mypy + Pydantic + Zod work together)
✅ GOOD: "DateTime Storage Strategy" (naive + timezone assumption inseparable)
❌ BAD: "Database Stack" (PostgreSQL + SQLAlchemy + Fly.io can change independently)
❌ BAD: "Deployment Stack" (API host + Web host + CI/CD independent)
```

---

## Audit Metrics

**Total ADRs audited:** 10
**Compliant:** 7 (70%)
**Violations:** 2 (20%)
**Borderline:** 1 (10%)

**Violations by severity:**
- **HIGH:** 2 (ADR-003, ADR-007)
- **MEDIUM:** 1 (ADR-005 - but recommended to keep)

**Estimated effort to fix:**
- Create 8 new ADRs: ~12 hours
- Update references: ~4 hours
- Update governance docs: ~2 hours
- **Total:** ~18 hours

**Benefits of fixing:**
- ✅ Granular superseding (change database without affecting ORM)
- ✅ Clearer decision boundaries
- ✅ Better historical traceability
- ✅ Easier to understand rationale for each choice
- ✅ Future-proof governance

---

## Next Steps

1. **Get user approval** for migration plan
2. **Create ADR-011** (CORS Security Policy) using correct pattern
3. **Split ADR-003** into 4 ADRs
4. **Split ADR-007** into 3-4 ADRs (reuse ADR-003D for database hosting)
5. **Update all references** systematically
6. **Update governance documentation** in CLAUDE.md

---

## Conclusion

The audit reveals that 7 out of 10 ADRs comply with the "One Decision Per ADR" principle. The 2 violations (ADR-003 and ADR-007) bundle independent choices for convenience rather than documenting cohesive strategies. Splitting these ADRs will:

1. **Improve governance**: Allow superseding individual decisions independently
2. **Clarify boundaries**: Make decision scope explicit
3. **Maintain backward compatibility**: No code changes required
4. **Establish precedent**: Guide future ADR creation

The migration is straightforward: create new granular ADRs, mark old ones as superseded, and update references. Total effort ~18 hours, but creates long-term governance clarity.
